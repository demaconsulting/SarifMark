---
on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
    secrets:
      SONAR_TOKEN:
        required: false

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Run markdown linter
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: '**/*.md'

      - name: Run spell checker
        uses: streetsidesoftware/cspell-action@v8
        with:
          files: '**/*.{md,cs}'

      - name: Run YAML linter
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yaml

  build:
    name: Build ${{ matrix.os }}
    needs: quality-checks
    permissions:
      contents: read

    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x

      - name: Restore Tools
        run: >
          dotnet tool restore

      - name: Restore Dependencies
        run: >
          dotnet restore

      - name: Build
        run: >
          dotnet build
          --no-restore
          --configuration Release
          --property:Version=${{ inputs.version }}

      - name: Test
        run: >
          dotnet test
          --no-build
          --configuration Release
          --property:Version=${{ inputs.version }}
          --collect "XPlat Code Coverage;Format=opencover"
          --logger "trx;LogFilePrefix=${{ matrix.os }}"
          --results-directory test-results

      - name: Generate SBOM
        run: >
          dotnet sbom-tool generate
          -b src/DemaConsulting.SarifMark/bin/Release
          -bc src/DemaConsulting.SarifMark
          -pn DemaConsulting.SarifMark
          -pv ${{ inputs.version }}
          -ps DemaConsulting
          -nsb https://DemaConsulting.com/SarifMark
          -pm true
          -li true

      - name: Generate Tests SBOM
        run: >
          dotnet sbom-tool generate
          -b test/DemaConsulting.SarifMark.Tests/bin/Release
          -bc test/DemaConsulting.SarifMark.Tests
          -pn DemaConsulting.SarifMark.Tests
          -pv ${{ inputs.version }}
          -ps DemaConsulting
          -nsb https://DemaConsulting.com/SarifMark.Tests
          -pm true
          -li true

      - name: Create Dotnet Tool
        run: >
          dotnet pack
          --no-build
          --no-restore
          --property:PackageVersion=${{ inputs.version }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.os }}
          path: test-results/*.trx

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: artifacts-${{ matrix.os }}
          path: |
            src/DemaConsulting.SarifMark/bin/Release/*.nupkg
            src/DemaConsulting.SarifMark/bin/Release/*.snupkg
            src/DemaConsulting.SarifMark/bin/Release/**/manifest.spdx.json
            src/DemaConsulting.SarifMark/bin/Release/**/manifest.spdx.json.sha256

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: quality-checks
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          queries: security-and-quality

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x

      - name: Restore Dependencies
        run: >
          dotnet restore

      - name: Build
        run: >
          dotnet build
          --no-restore
          --configuration Release
          --property:Version=${{ inputs.version }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"
          output: sarif-results
          upload: false

      - name: Upload CodeQL SARIF
        uses: actions/upload-artifact@v6
        with:
          name: codeql-sarif
          path: sarif-results/csharp.sarif

  integration-test:
    name: Integration Test ${{ matrix.os }} .NET ${{ matrix.dotnet-version }}
    runs-on: ${{ matrix.os }}
    needs: build
    permissions:
      contents: read

    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
        dotnet-version: ['8.x', '9.x', '10.x']

    steps:
      - name: Download package
        uses: actions/download-artifact@v7
        with:
          name: artifacts-${{ matrix.os }}
          path: packages

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Install tool from package
        shell: bash
        run: |
          echo "Installing package version ${{ inputs.version }} from: packages/"
          dotnet tool install --global \
            --add-source packages \
            --version ${{ inputs.version }} \
            DemaConsulting.SarifMark

      - name: Test version display
        shell: bash
        run: |
          echo "Testing sarifmark --version..."
          sarifmark --version || { echo "✗ Version command failed"; exit 1; }
          echo "✓ Version command succeeded"

      - name: Test help display
        shell: bash
        run: |
          echo "Testing sarifmark --help..."
          sarifmark --help || { echo "✗ Help command failed"; exit 1; }
          echo "✓ Help command succeeded"

      - name: Run SarifMark self-validation
        shell: bash
        run: |
          echo "Running SarifMark self-validation..."
          sarifmark --validate --results integration-test-${{ matrix.os }}-dotnet${{ matrix.dotnet-version }}.trx \
            || { echo "✗ Self-validation failed"; exit 1; }
          echo "✓ Self-validation succeeded"

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-results-${{ matrix.os }}-dotnet${{ matrix.dotnet-version }}
          path: integration-test-${{ matrix.os }}-dotnet${{ matrix.dotnet-version }}.trx

  build-docs:
    name: Build Documentation
    runs-on: windows-latest
    needs: [build, integration-test, codeql]
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'

      - name: Download all test results
        uses: actions/download-artifact@v7
        with:
          path: test-results
          pattern: '*test-results*'
        continue-on-error: true

      - name: Download SarifMark package
        uses: actions/download-artifact@v7
        with:
          name: artifacts-windows-latest
          path: packages

      - name: Download CodeQL SARIF
        uses: actions/download-artifact@v7
        with:
          name: codeql-sarif
          path: codeql-results

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.x

      - name: Install npm dependencies
        run: npm install

      - name: Install SarifMark from package
        shell: pwsh
        run: |
          echo "Installing SarifMark version ${{ inputs.version }}"
          dotnet tool install --global `
            --add-source packages `
            --version ${{ inputs.version }} `
            DemaConsulting.SarifMark

      - name: Restore Tools
        run: dotnet tool restore

      - name: Generate CodeQL Quality Report with SarifMark
        shell: pwsh
        run: |
          echo "Generating CodeQL quality report..."
          sarifmark `
            --sarif codeql-results/csharp.sarif `
            --report docs/quality/codeql-quality.md `
            --heading "CodeQL Analysis" `
            --report-depth 1

      - name: Generate SonarCloud Quality Report with SonarMark
        shell: pwsh
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if ($env:SONAR_TOKEN) {
            echo "Generating SonarCloud quality report..."
            dotnet sonarmark `
              --server https://sonarcloud.io `
              --project-key demaconsulting_SarifMark `
              --branch ${{ github.ref_name }} `
              --token "$env:SONAR_TOKEN" `
              --report docs/quality/sonar-quality.md `
              --report-depth 1
          } else {
            echo "Skipping SonarCloud report - no token available"
            echo "# SonarCloud Analysis" > docs/quality/sonar-quality.md
            echo "" >> docs/quality/sonar-quality.md
            echo "SonarCloud analysis not available for this build." >> docs/quality/sonar-quality.md
          }

      - name: Generate Guide HTML with Pandoc
        run: >
          dotnet pandoc
          --defaults docs/guide/definition.yaml
          --filter node_modules/.bin/mermaid-filter.cmd
          --output docs/guide/guide.html

      - name: Generate Guide PDF with Weasyprint
        run: >
          dotnet weasyprint
          --pdf-variant pdf/a-3u
          docs/guide/guide.html
          "docs/SarifMark User Guide.pdf"

      - name: Generate Code Quality HTML with Pandoc
        run: >
          dotnet pandoc
          --defaults docs/quality/definition.yaml
          --filter node_modules/.bin/mermaid-filter.cmd
          --output docs/quality/quality.html

      - name: Generate Code Quality PDF with Weasyprint
        run: >
          dotnet weasyprint
          --pdf-variant pdf/a-3u
          docs/quality/quality.html
          "docs/SarifMark Code Quality.pdf"

      - name: Upload documentation
        uses: actions/upload-artifact@v6
        with:
          name: documentation
          path: docs/*.pdf
